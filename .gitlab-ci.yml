stages:
  - build
  - deploy

variables:
  DOCKER_IMAGE: gyujh630/moya-be
  MATTERMOST_WEBHOOK: https://meeting.ssafy.com/hooks/pcebpjkxftr9889opyiu3i9mbh

# ê³µí†µ í•¨ìˆ˜ ì •ì˜
.send_mattermost_message:
  script:
    - |
      function notify_mattermost() {
        local type="$1"     # build, deploy
        local status="$2"   # success, fail
        local env="$3"      # ê°œë°œ, ìš´ì˜ (buildëŠ” ì—†ìŒ)
        local error_msg="${4:-""}"

        local emoji=":white_check_mark:"
        local title=""

        if [[ "$type" == "build" ]]; then
          title="*ë°±ì—”ë“œ ë¹Œë“œ ì‹¤íŒ¨*"
          emoji=":x:"
        else
          if [[ "$status" == "fail" ]]; then
            emoji=":x:"
            title="*ë°±ì—”ë“œ ${env}ì„œë²„ ë°°í¬ ì‹¤íŒ¨*"
          else
            title="*ë°±ì—”ë“œ ${env}ì„œë²„ ë°°í¬ ì™„ë£Œ*"
          fi
        fi

        curl -X POST -H 'Content-Type: application/json' -d "{
          \"username\": \"ğŸš€ Moya CI/CD Bot\",
          \"text\": \"${emoji} ${title}\nbranch: \`$CI_COMMIT_BRANCH\`\ncommitter: *$GITLAB_USER_NAME*\ncommit message: $CI_COMMIT_MESSAGE${error_msg:+\nerror: $error_msg}\"
        }" $MATTERMOST_WEBHOOK
      }
    - export -f notify_mattermost

# BE - ë¹Œë“œ
build-be:
  stage: build
  extends: .send_mattermost_message
  script:
    - set -e
    - docker build -t $DOCKER_IMAGE:$CI_COMMIT_BRANCH ./backend
    - docker push $DOCKER_IMAGE:$CI_COMMIT_BRANCH
  after_script:
    - |
      if [[ "$CI_JOB_STATUS" != "success" ]]; then
        notify_mattermost "build" "fail" "" "$(tail -n 20 /root/.gitlab-runner/builds/*/builds.log | tr '\n' ' ' | cut -c -500)"
      fi
  tags: [ec2]
  only:
    - be-dev
    - be-main
    - master

# BE - ê°œë°œ í™˜ê²½ ë°°í¬
deploy-be-dev:
  stage: deploy
  extends: .send_mattermost_message
  script:
    - set -e
    - docker pull $DOCKER_IMAGE:$CI_COMMIT_BRANCH
    - docker stop be-dev || true
    - docker rm be-dev || true
    - |
      docker run -d --name be-dev -p 8081:8080 \
        -e DB_URL="$DB_URL_DEV" \
        -e DB_USERNAME="$DB_USERNAME" \
        -e DB_PASSWORD="$DB_PASSWORD" \
        $DOCKER_IMAGE:$CI_COMMIT_BRANCH
  after_script:
    - |
      if [[ "$CI_JOB_STATUS" == "success" ]]; then
        notify_mattermost "deploy" "success" "ê°œë°œ"
      else
        notify_mattermost "deploy" "fail" "ê°œë°œ" "$(tail -n 20 /root/.gitlab-runner/builds/*/builds.log | tr '\n' ' ' | cut -c -500)"
      fi
  tags: [ec2]
  only: [be-dev]

# BE - ìš´ì˜ í™˜ê²½ ë°°í¬
deploy-be-prod:
  stage: deploy
  extends: .send_mattermost_message
  script:
    - set -e
    - docker pull $DOCKER_IMAGE:$CI_COMMIT_BRANCH
    - docker stop be-main || true
    - docker rm be-main || true
    - |
      docker run -d --name be-main -p 8080:8080 \
        -e DB_URL="$DB_URL_PROD" \
        -e DB_USERNAME="$DB_USERNAME" \
        -e DB_PASSWORD="$DB_PASSWORD" \
        $DOCKER_IMAGE:$CI_COMMIT_BRANCH
  after_script:
    - |
      if [[ "$CI_JOB_STATUS" == "success" ]]; then
        notify_mattermost "deploy" "success" "ìš´ì˜"
      else
        notify_mattermost "deploy" "fail" "ìš´ì˜" "$(tail -n 20 /root/.gitlab-runner/builds/*/builds.log | tr '\n' ' ' | cut -c -500)"
      fi
  tags: [ec2]
  only:
    - be-main
    - master
